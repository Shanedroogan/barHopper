{% extends "base.html" %}

{% block app_content %}
<div id="alert"></div>
<!--Buttons-->
<div class="row" style = "margin-bottom: 0px; padding-bottom: 0px; margin-top:1.1rem">
    <!--Back Button-->
    <div class="col-md-6">
        <a href ="{{ url_for('customize_crawl') }}" type = "button" class="btn btn-secondary"><i class="fas fa-angle-left"></i> Go Back</a>
    </div><!--End Back Button-->
    <div class="col-md-4">
      {% if not saved %}
        <form action="">
            <input type="button" id = "submit" name="save" class="btn btn-secondary" value="Save to Profile"/>
        </form>
      {% else %}
        <button class= "btn btn-secondary" disabled>Saved <i class="fas fa-check"></i></button>
      {% endif %}
    </div>
</div><!--End Buttons-->

<div class = "row" style="margin-top: 0px; padding-top: 0px;">
    <!--Bar Information-->
    <div class="col-md-6">
      <div class="accordion">
        {% for bar in bars %}
        {% set bar_index = loop.index0 %}
        <div class="card">
          <div class="row">
            <div class="col-3">
              {% include '_output_tab_nav.html' %}
            </div>
            <div class="col-9">
              {% include '_output_tab_content.html' %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div><!--End Bar Information-->
    <!--Interactive Map-->
    <div class = "col-md-6">
      <div id="map">

      </div>
    </div><!--End Interactive Map-->
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
<script>
  var polyline = ""
  // Initialize and add the map
  function initMap() {
    //Init directions service
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer();
    // The location of the bar hop
    var hop = {lat: {{bars[2].latitude|safe}}, lng: {{bars[2].longitude|safe}}};
    var mapOptions = {
      zoom : 14,
      center : hop
    }
    // The map, centered at the barhop
    var map = new google.maps.Map(
        document.getElementById('map'), mapOptions);
    directionsRenderer.setMap(map)
  }
  function calcRoute() {
  var start = new google.maps.LatLng({{ bars[0].latitude|safe }}, {{ bars[0].longitude|safe }});
  var end = new google.maps.LatLng({{ bars[-1].latitude|safe }}, {{ bars[-1].longitude|safe }});
  var request = {
    origin: start,
    destination: end,
    travelMode: 'WALKING',
    waypoints : [
        {
          location: new google.maps.LatLng({{bars[1].latitude}}, {{bars[1].longitude}}),
          stopover : true
        },{
          location: new google.maps.LatLng({{bars[2].latitude}}, {{bars[2].longitude}}),
          stopover : true
        },{
          location: new google.maps.LatLng({{bars[3].latitude}}, {{bars[3].longitude}}),
          stopover : true
        },{
          location: new google.maps.LatLng({{bars[4].latitude}}, {{bars[4].longitude}}),
          stopover : true
        }],
        optimizeWaypoints : true
  };
  directionsService.route(request, function(result, status) {
    if (status == 'OK') {
      directionsRenderer.setDirections(result);
      polyline = result.routes[0].overview_polyline
    }
  });
}
$('#submit').click(function() {
        console.log(polyline);
        $.ajax({
          type: "POST",
          contentType: "application/json;charset=utf-8",
          url: "{{ url_for('output', result_list=request.args.get('result_list')) }}",
          traditional: "true",
          data: JSON.stringify({polyline}),
          dataType: "json"
          });
          this.value = "Saved!"
          $(this).prop('disabled', true);
    });
  </script>
      <script async defer
      src='{{ maps_endpoint }}'>
      </script>
      <script>
        window.onload = calcRoute
      </script>
{% endblock %}